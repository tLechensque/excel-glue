<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor Universal de Planilhas</title>
    <meta name="description" content="Ferramenta para conversão de arquivos Excel complexos em formato padronizado">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d'
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .step-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .step-enabled {
            opacity: 1;
            pointer-events: auto;
        }
        .drag-area {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .drag-area:hover {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }
        .drag-area.drag-over {
            border-color: #22c55e;
            background-color: #f0fdf4;
        }
        .step-indicator {
            position: relative;
        }
        .step-indicator::after {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -20px;
            width: 2px;
            height: 20px;
            background-color: #e5e7eb;
            transform: translateX(-50%);
        }
        .step-indicator:last-child::after {
            display: none;
        }
        .step-active .step-indicator::after {
            background-color: #22c55e;
        }
        .step-active .step-indicator {
            background-color: #22c55e !important;
            color: white !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-file-excel text-primary-500 mr-3"></i>
                    Conversor Universal de Planilhas
                </h1>
                <p class="text-gray-600 text-lg">
                    Transforme arquivos Excel complexos em formato padronizado de forma simples
                </p>
            </div>
        </div>
    </header>

    <!-- Progress Indicator -->
    <div class="bg-white border-b">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-8">
                    <!-- Step 1 -->
                    <div class="flex items-center step-active" id="step1-indicator">
                        <div class="step-indicator flex items-center justify-center w-10 h-10 bg-primary-500 text-white rounded-full font-bold text-sm">
                            1
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900">Upload</p>
                            <p class="text-xs text-gray-500">Carregar arquivo</p>
                        </div>
                    </div>
                    
                    <!-- Step 2 -->
                    <div class="flex items-center" id="step2-indicator">
                        <div class="step-indicator flex items-center justify-center w-10 h-10 bg-gray-200 text-gray-400 rounded-full font-bold text-sm">
                            2
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-400">Configuração</p>
                            <p class="text-xs text-gray-400">Abas e chaves</p>
                        </div>
                    </div>
                    
                    <!-- Step 3 -->
                    <div class="flex items-center" id="step3-indicator">
                        <div class="step-indicator flex items-center justify-center w-10 h-10 bg-gray-200 text-gray-400 rounded-full font-bold text-sm">
                            3
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-400">Mapeamento</p>
                            <p class="text-xs text-gray-400">Configurar campos</p>
                        </div>
                    </div>
                    
                    <!-- Step 4 -->
                    <div class="flex items-center" id="step4-indicator">
                        <div class="step-indicator flex items-center justify-center w-10 h-10 bg-gray-200 text-gray-400 rounded-full font-bold text-sm">
                            4
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-400">Finalizar</p>
                            <p class="text-xs text-gray-400">Baixar resultado</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
        
        <!-- Seção 1: Upload do Arquivo (Passo 1) -->
        <section class="bg-white rounded-lg shadow-sm border p-8" id="section1">
            <div class="flex items-center mb-6">
                <div class="flex items-center justify-center w-8 h-8 bg-primary-500 text-white rounded-full font-bold text-sm mr-3">
                    1
                </div>
                <h2 class="text-2xl font-semibold text-gray-900">
                    Passo 1: Carregue seu arquivo Excel (.xlsx)
                </h2>
            </div>
            
            <!-- Campos de Posição Inicial -->
            <div class="mb-6">
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <h3 class="text-sm font-medium text-amber-800 mb-3">
                        <i class="fas fa-info-circle mr-2"></i>
                        Configuração de Posição dos Dados
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="headerRow" class="block text-sm font-medium text-gray-700 mb-1">
                                Linha do Cabeçalho:
                            </label>
                            <input 
                                type="number" 
                                id="headerRow" 
                                value="5" 
                                min="1" 
                                max="1000"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            >
                            <p class="text-xs text-gray-500 mt-1">Em qual linha estão os cabeçalhos?</p>
                        </div>
                        <div>
                            <label for="startColumn" class="block text-sm font-medium text-gray-700 mb-1">
                                Coluna de Início:
                            </label>
                            <input 
                                type="text" 
                                id="startColumn" 
                                value="B" 
                                maxlength="3"
                                pattern="[A-Z]+"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                            >
                            <p class="text-xs text-gray-500 mt-1">Em qual coluna começam os dados? (ex: A, B, AA)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="drag-area rounded-lg p-12 text-center cursor-pointer" id="dropArea">
                <div class="max-w-md mx-auto">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">
                        Arraste e solte seu arquivo aqui
                    </h3>
                    <p class="text-gray-500 mb-4">
                        ou clique para selecionar um arquivo
                    </p>
                    <button class="bg-primary-500 hover:bg-primary-600 text-white px-6 py-2 rounded-lg font-medium transition-colors" id="selectFileBtn">
                        Selecionar Arquivo
                    </button>
                    <p class="text-xs text-gray-400 mt-3">
                        Suporta arquivos .xlsx e .xls (máx. 50MB)
                    </p>
                </div>
                <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
            </div>
            
            <!-- Status de Carregamento -->
            <div id="loadingStatus" class="hidden mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-spinner fa-spin text-blue-500 mr-3"></i>
                    <span class="text-blue-700">Carregando arquivo...</span>
                </div>
            </div>
            
            <!-- Resultado do Upload -->
            <div id="uploadResult" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-3"></i>
                    <span class="text-green-700" id="uploadResultText">Arquivo carregado com sucesso!</span>
                </div>
            </div>
        </section>

        <!-- Seção 2: Seleção de Abas e Chave (Passo 2) -->
        <section class="bg-white rounded-lg shadow-sm border p-8 step-disabled" id="section2">
            <div class="flex items-center mb-6">
                <div class="flex items-center justify-center w-8 h-8 bg-gray-300 text-gray-500 rounded-full font-bold text-sm mr-3">
                    2
                </div>
                <h2 class="text-2xl font-semibold text-gray-500">
                    Passo 2: Selecione as Abas e a Chave de Ligação
                </h2>
            </div>
            
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Seleção de Abas -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Aba Principal de Produtos:
                        </label>
                        <select id="productSheet" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            <option value="">Selecione a aba...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Aba de Imagens:
                        </label>
                        <select id="imageSheet" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            <option value="">Selecione a aba...</option>
                        </select>
                    </div>
                </div>
                
                <!-- Chave de Ligação -->
                <div class="space-y-6">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">
                            <i class="fas fa-link text-primary-500 mr-2"></i>
                            Coluna de Ligação (Chave):
                        </h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Coluna da Aba Principal:
                                </label>
                                <select id="productKeyColumn" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Selecione a coluna...</option>
                                </select>
                            </div>
                            
                            <div class="text-center">
                                <i class="fas fa-arrows-alt-v text-gray-400"></i>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Coluna da Aba de Imagens:
                                </label>
                                <select id="imageKeyColumn" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Selecione a coluna...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Seção 3: Mapeamento de Colunas (Passo 3) -->
        <section class="bg-white rounded-lg shadow-sm border p-8 step-disabled" id="section3">
            <div class="flex items-center mb-6">
                <div class="flex items-center justify-center w-8 h-8 bg-gray-300 text-gray-500 rounded-full font-bold text-sm mr-3">
                    3
                </div>
                <h2 class="text-2xl font-semibold text-gray-500">
                    Passo 3: Mapeie as Colunas para o Formato Padrão
                </h2>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-6">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 font-medium text-gray-900">Campo do Sistema</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-900">Sua Coluna</th>
                                <th class="text-left py-3 px-4 font-medium text-gray-900">Obrigatório</th>
                            </tr>
                        </thead>
                        <tbody id="mappingTableBody">
                            <!-- Será populado dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Seção 4: Ação Final -->
        <section class="bg-white rounded-lg shadow-sm border p-8">
            <div class="text-center">
                <button id="processBtn" class="bg-gray-300 text-gray-500 px-8 py-4 rounded-lg font-semibold text-lg cursor-not-allowed inline-flex items-center" disabled>
                    <i class="fas fa-download mr-3"></i>
                    Processar e Baixar Arquivo Convertido
                </button>
                <p class="text-sm text-gray-400 mt-3">
                    Complete os passos anteriores para habilitar o processamento
                </p>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-16">
        <div class="max-w-6xl mx-auto px-4 py-6">
            <div class="text-center text-gray-500 text-sm">
                <p>© 2024 Conversor Universal de Planilhas - Ferramenta de conversão Excel</p>
            </div>
        </div>
    </footer>

    <script>
        // Variáveis globais
        let workbook = null;
        let currentSheetData = {};
        
        // Campos do sistema para mapeamento
        const systemFields = [
            { key: 'NOME', label: 'Nome do Produto', required: true },
            { key: 'SKU', label: 'SKU/Código', required: true },
            { key: 'PRECO_CUSTO', label: 'Preço de Custo', required: false },
            { key: 'PRECO_VENDA', label: 'Preço de Venda', required: false },
            { key: 'DESCRICAO_COMPLETA', label: 'Descrição Completa', required: false },
            { key: 'CATEGORIA', label: 'Categoria', required: false },
            { key: 'ESTOQUE', label: 'Estoque', required: false },
            { key: 'IMAGENS', label: 'URLs das Imagens', required: false },
        ];

        // Função para converter letra da coluna para número (A=1, B=2, etc.)
        function columnLetterToNumber(letter) {
            let result = 0;
            for (let i = 0; i < letter.length; i++) {
                result = result * 26 + (letter.charCodeAt(i) - 'A'.charCodeAt(0) + 1);
            }
            return result - 1; // Convertendo para índice baseado em 0
        }

        // Função para ler dados de uma posição customizada
        function readSheetFromPosition(worksheet, startRow, startCol) {
            if (!worksheet) return [];
            
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            const startColIndex = columnLetterToNumber(startCol.toUpperCase());
            const data = [];
            
            // Começar da linha especificada (convertendo para índice baseado em 0)
            for (let row = startRow - 1; row <= range.e.r; row++) {
                const rowData = [];
                for (let col = startColIndex; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    const cell = worksheet[cellAddress];
                    rowData.push(cell ? cell.v : '');
                }
                // Só adicionar linhas que não estão completamente vazias
                if (rowData.some(cell => cell !== '')) {
                    data.push(rowData);
                }
            }
            
            return data;
        }

        // Função para atualizar o indicador de progresso
        function updateStepIndicator(activeStep) {
            const steps = ['step1-indicator', 'step2-indicator', 'step3-indicator', 'step4-indicator'];
            
            steps.forEach((stepId, index) => {
                const stepElement = document.getElementById(stepId);
                const isActive = index + 1 <= activeStep;
                
                if (isActive) {
                    stepElement.classList.add('step-active');
                    stepElement.querySelector('.step-indicator').classList.remove('bg-gray-200', 'text-gray-400');
                    stepElement.querySelector('.step-indicator').classList.add('bg-primary-500', 'text-white');
                    stepElement.querySelectorAll('p').forEach(p => {
                        p.classList.remove('text-gray-400');
                        p.classList.add('text-gray-900');
                    });
                } else {
                    stepElement.classList.remove('step-active');
                    stepElement.querySelector('.step-indicator').classList.add('bg-gray-200', 'text-gray-400');
                    stepElement.querySelector('.step-indicator').classList.remove('bg-primary-500', 'text-white');
                    stepElement.querySelectorAll('p').forEach(p => {
                        p.classList.add('text-gray-400');
                        p.classList.remove('text-gray-900');
                    });
                }
            });
        }

        // Função para habilitar/desabilitar seções
        function enableSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.remove('step-disabled');
            section.classList.add('step-enabled');
            
            // Atualizar títulos
            const title = section.querySelector('h2');
            title.classList.remove('text-gray-500');
            title.classList.add('text-gray-900');
            
            const stepNumber = section.querySelector('.w-8.h-8');
            stepNumber.classList.remove('bg-gray-300', 'text-gray-500');
            stepNumber.classList.add('bg-primary-500', 'text-white');
        }

        // Função para processar o arquivo Excel
        function processExcelFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    // Popular dropdown de abas
                    populateSheetDropdowns();
                    
                    // Habilitar seção 2
                    enableSection('section2');
                    updateStepIndicator(2);
                    
                    // Mostrar resultado de sucesso
                    document.getElementById('loadingStatus').classList.add('hidden');
                    document.getElementById('uploadResult').classList.remove('hidden');
                    document.getElementById('uploadResultText').textContent = 
                        `Arquivo carregado com sucesso! ${workbook.SheetNames.length} aba(s) encontrada(s).`;
                    
                } catch (error) {
                    document.getElementById('loadingStatus').classList.add('hidden');
                    alert('Erro ao processar o arquivo: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Função para popular os dropdowns de abas
        function populateSheetDropdowns() {
            const productSelect = document.getElementById('productSheet');
            const imageSelect = document.getElementById('imageSheet');
            
            // Limpar opções existentes
            productSelect.innerHTML = '<option value="">Selecione a aba...</option>';
            imageSelect.innerHTML = '<option value="">Selecione a aba...</option>';
            
            // Adicionar abas encontradas
            workbook.SheetNames.forEach(sheetName => {
                const option1 = new Option(sheetName, sheetName);
                const option2 = new Option(sheetName, sheetName);
                productSelect.add(option1);
                imageSelect.add(option2);
            });
        }

        // Função para popular colunas de uma aba
        function populateColumnDropdown(selectId, sheetName) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Selecione a coluna...</option>';
            
            if (!sheetName || !workbook.Sheets[sheetName]) return;
            
            const headerRow = parseInt(document.getElementById('headerRow').value);
            const startColumn = document.getElementById('startColumn').value;
            
            const sheetData = readSheetFromPosition(workbook.Sheets[sheetName], headerRow, startColumn);
            
            if (sheetData.length > 0) {
                const headers = sheetData[0]; // Primeira linha são os cabeçalhos
                headers.forEach((header, index) => {
                    if (header && header.toString().trim() !== '') {
                        const option = new Option(header, header);
                        select.add(option);
                    }
                });
                
                // Salvar dados da aba para uso posterior
                currentSheetData[sheetName] = sheetData;
            }
        }

        // Função para popular a tabela de mapeamento
        function populateMappingTable() {
            const tbody = document.getElementById('mappingTableBody');
            tbody.innerHTML = '';
            
            const productSheet = document.getElementById('productSheet').value;
            const imageSheet = document.getElementById('imageSheet').value;
            
            let availableColumns = [];
            
            // Obter colunas disponíveis das abas selecionadas
            if (productSheet && currentSheetData[productSheet]) {
                availableColumns = [...availableColumns, ...currentSheetData[productSheet][0]];
            }
            if (imageSheet && currentSheetData[imageSheet]) {
                availableColumns = [...availableColumns, ...currentSheetData[imageSheet][0]];
            }
            
            // Remover duplicatas
            availableColumns = [...new Set(availableColumns)].filter(col => col && col.toString().trim() !== '');
            
            systemFields.forEach(field => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-100';
                
                row.innerHTML = `
                    <td class="py-3 px-4 font-medium">${field.label}</td>
                    <td class="py-3 px-4">
                        <select class="w-full px-3 py-1 border border-gray-300 rounded text-sm" data-field="${field.key}">
                            <option value="">Selecione...</option>
                            ${availableColumns.map(col => `<option value="${col}">${col}</option>`).join('')}
                        </select>
                    </td>
                    <td class="py-3 px-4">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                            field.required ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600'
                        }">
                            ${field.required ? 'Sim' : 'Não'}
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');
            const selectFileBtn = document.getElementById('selectFileBtn');
            
            // Click para selecionar arquivo
            selectFileBtn.addEventListener('click', () => fileInput.click());
            dropArea.addEventListener('click', () => fileInput.click());
            
            // Drag and Drop
            dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropArea.classList.add('drag-over');
            });
            
            dropArea.addEventListener('dragleave', () => {
                dropArea.classList.remove('drag-over');
            });
            
            dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                dropArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
            
            // Seleção de arquivo
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
            
            // Mudança de aba de produtos
            document.getElementById('productSheet').addEventListener('change', function() {
                if (this.value) {
                    populateColumnDropdown('productKeyColumn', this.value);
                    updateMappingIfReady();
                }
            });
            
            // Mudança de aba de imagens
            document.getElementById('imageSheet').addEventListener('change', function() {
                if (this.value) {
                    populateColumnDropdown('imageKeyColumn', this.value);
                    updateMappingIfReady();
                }
            });
        });

        function handleFileUpload(file) {
            // Verificar tipo de arquivo
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('Por favor, selecione um arquivo Excel (.xlsx ou .xls)');
                return;
            }
            
            // Verificar tamanho (50MB)
            if (file.size > 50 * 1024 * 1024) {
                alert('Arquivo muito grande. Tamanho máximo: 50MB');
                return;
            }
            
            // Mostrar loading
            document.getElementById('uploadResult').classList.add('hidden');
            document.getElementById('loadingStatus').classList.remove('hidden');
            
            // Processar arquivo
            processExcelFile(file);
        }

        function updateMappingIfReady() {
            const productSheet = document.getElementById('productSheet').value;
            const imageSheet = document.getElementById('imageSheet').value;
            
            if (productSheet && imageSheet) {
                enableSection('section3');
                updateStepIndicator(3);
                populateMappingTable();
            }
        }
    </script>
</body>
</html>